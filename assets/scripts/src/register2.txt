const pageRegistration = document.querySelector(
  ".body-registration"
) as HTMLBodyElement;
const formRegister =
  document.querySelector<HTMLFormElement>(".form-registration");
const inputs = document.querySelectorAll(".form-register input") as NodeList;
const btnRegister = document.querySelector(
  ".send-register"
) as HTMLButtonElement;

type AnyObject = {
  [key: string]: any;
};

let values = {} as AnyObject;

// FUNÇÃO VALIDA NOME: ACEITA APENAS LETRAS, ESPAÇOS, ACENTOS
function validateName(name: string) {
  let span = document.querySelector(".name-mensagem-erro") as HTMLSpanElement;
  let regexName = /^[a-záàâãéèêíïóôõöúçñ ]+$/i;
  let nomeValido = name.split(/ +/).every((parte) => regexName.test(parte));
  span.innerHTML = "";
  if (name == "" || !nomeValido) {
    span.innerHTML = "Nome não é válido";
    name = "";
    return false;
  } else {
    span.innerHTML = "";
    return true;
  }
}

// FUNÇÃO VALIDA QUANTIDADE MÍNIMA DE 6 CARACTERES PARA SENHA
// ADICIONAR QUANTIDADE MÁXIMA
function validatePassword(password: string) {
  let span = document.querySelector(
    ".password-mensagem-erro"
  ) as HTMLSpanElement;
  if (password.length < 6 || password == "") {
    span.innerHTML = "A senha deve ter no mínimo 6 caracteres";
    return false;
  } else {
    span.innerHTML = "";
    return true;
  }
}
// VERIFICA SE O EMAIL JÁ EXISTE NO CADASTRO
function emailExists(email: string) {
  let span = document.querySelector(".email-mensagem-erro") as HTMLSpanElement;
  for (var i = 0; i < localStorage.length; i++) {
    const chave: string = localStorage.key(i)!;
    if (chave.includes("email")) {
      const valor: string | null = localStorage.getItem(chave);
      if (valor === email) {
        console.log("e-mail já existe no cadstro");
        return true;
      }
    }
  }
  console.log("Email não existe");
  // return false;
}
function validateEmail(email: string) {
  var regexEmail = /\S+@\S+\.\S+/;
  let span = document.querySelector(".email-mensagem-erro") as HTMLSpanElement;
  span.innerHTML = "";
  let emailValido = regexEmail.test(email);
  if (!emailValido || email == "") {
    console.log("email não é válido");
    span.innerHTML = "E-mail não é válido";
    return false;
  } else if (emailExists(email)) {
    span.innerHTML = "E-mail já existe no cadastro";
    console.log("EMAIL JÁ EXISTE");
    return false;
  } else {
    span.innerHTML = "";
    console.log("EMAIL OK");

    return true;
  }
}

function getFormValues(formEl: HTMLFormElement) {
  const userItem: string | number | null = localStorage.getItem("user");
  let arrUser = [];

  if (userItem) {
    const parsedItems = JSON.parse(userItem);

    if (Array.isArray(parsedItems)) {
      arrUser = parsedItems;
    }
  }
  // PEGANDO OS DADOS DO FORM

  const form = new FormData(formEl);

  form.forEach((value, key) => {
    values[key] = value;
  });
  const { email, name, password } = values;

  arrUser.sort((a, b) => a.id - b.id);
  const lastItem = arrUser[arrUser.length - 1];
  const newId = lastItem ? lastItem.id + 1 : 1;
  values.id = newId;
  // VERIFICA SE E-MAIL JÁ EXISTE
  if (emailExists(email)) {
    console.log("EMAIL JÁ EXISTE NO CADASTRO");
    return;
  }
  // SE OS DADOS ESTÃO VÁLIDOS ARMAZENA NO LOCALSTORAGE

  if (
    validateName(name) &&
    validateEmail(email) &&
    validatePassword(password)
  ) {
    arrUser.push(values);
    localStorage.setItem("user", JSON.stringify(arrUser));
    alert("Cadastro realizado!");
    window.location.href = "auth.html";
  }
}
// CRIANDO ID

if (formRegister) {
  formRegister.addEventListener("submit", (e) => {
    e.preventDefault();
    getFormValues(formRegister);
  });
}
